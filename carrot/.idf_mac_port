#!/bin/bash

function idf_mac_serial_set() {
    local serial_port=""

    # avail serial port on mac
    local results=$(ls /dev/cu.* | grep -E "(usbserial|usbmodem)" 2> /dev/null)
    #local results=$(ls /dev/cu.* 2> /dev/null)

    IFS=$'\n' ports=($(echo $results))
    port_num=${#ports[@]}

    if [[ $port_num -eq 1 ]]; then
        serial_port=${ports[1]} 
    elif [[ $port_num -ge 2 ]]; then
        echo "List of available ports on your machine"
        i=1
        max=${#ports[@]}
        for p in ${ports[@]}; do
            echo "$i) $p"
            ((i=i+1))
        done

        selected=1  # default first port
        echo -n "Select the port for the ESP-IDF monitor/flash[1]: "
        read answer
        if [ ! -z "$answer" ] && ((1<=$answer && $answer<=$max)); then
            selected=$(($answer))
        fi

        echo "selected: $selected"
        serial_port=${ports[$selected]}
    fi

    eval "$1='$serial_port'"
}

# setup serial port for the ESP-IDF monitor/flash
idf_mac_serial_set idf_serial_port

BLUE='\033[034m'
RED='\033[31m'
NC='\033[0m' # No Color

if [[ -n $idf_serial_port ]]; then
    echo "${BLUE}"
    echo "You will use [${idf_serial_port}] for the ESP-IDF monitor/flash"
    echo "${NC}"
else
    echo "${RED}"
    echo "Warning: No ESP-IDF COM for monitor/flash"
    echo "${NC}"
fi

export ESP_IDF_COM=${idf_serial_port}

# end of file
